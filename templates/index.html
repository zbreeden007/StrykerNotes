{% extends 'base.html' %}

{% block title %}Dashboard - Stryker Notes{% endblock %}

{% block extra_head %}
<!-- SortableJS for drag-and-drop functionality -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
  /* Direct styling to override any conflicting CSS */
  #addTaskFormContainer {
    display: none; /* Start hidden */
  }
  
  #addTaskFormContainer.show-form {
    display: block !important; /* Use !important to override other styles */
    background-color: #f8f9fa;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
  }
  
  /* Email buttons styling */
  .email-btn {
    background-color: #BF8A36;
    color: white;
    border: none;
    padding: 8px 15px;
    transition: all 0.3s ease;
    margin-left: 10px;
  }
  
  .email-btn:hover {
    background-color: #a77830;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    color: white;
  }
  
  .email-btn i {
    margin-right: 5px;
  }
  
  /* Email settings button */
  .email-settings-btn {
    background: none;
    border: none;
    color: white;
    font-size: 0.85rem;
    margin-left: 5px;
    padding: 0;
    cursor: pointer;
  }
  
  /* Email recipient list */
  .email-recipient-list {
    max-height: 200px;
    overflow-y: auto;
  }
  
  .recipient-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 5px;
  }
  
  .recipient-item .remove-btn {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header with Email Buttons -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0" style="color: #FFFFFF;">Dashboard</h1>
    <div class="d-flex align-items-center">
        <div class="btn-group">
            <a href="#" class="btn email-btn internal-email-btn" id="internalReportingBtn">
                <i class="fas fa-envelope"></i> Internal Reporting Issue
            </a>
            <button type="button" class="email-settings-btn" data-bs-toggle="modal" data-bs-target="#internalEmailModal">
                <i class="fas fa-cog"></i>
            </button>
        </div>
        <div class="btn-group">
            <a href="#" class="btn email-btn external-email-btn" id="externalReportingBtn">
                <i class="fas fa-envelope-open-text"></i> External Reporting Issue
            </a>
            <button type="button" class="email-settings-btn" data-bs-toggle="modal" data-bs-target="#externalEmailModal">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>
</div>

<!-- Email Distribution Modals -->
<!-- Internal Email Modal -->
<div class="modal fade" id="internalEmailModal" tabindex="-1" aria-labelledby="internalEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="internalEmailModalLabel">Internal Reporting Email Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="internalEmailForm">
                    <div class="mb-3">
                        <label for="internalSubject" class="form-label">Email Subject</label>
                        <input type="text" class="form-control" id="internalSubject" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Recipients</label>
                        <div class="email-recipient-list mb-2" id="internalRecipientList">
                            <!-- Recipients will be added here dynamically -->
                        </div>
                        
                        <div class="input-group">
                            <input type="email" class="form-control" id="internalNewRecipient" placeholder="Add new recipient email">
                            <button class="btn btn-outline-secondary" type="button" id="internalAddRecipient">Add</button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="internalBodyTemplate" class="form-label">Email Template</label>
                        <textarea class="form-control" id="internalBodyTemplate" rows="6"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveInternalEmail">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- External Email Modal -->
<div class="modal fade" id="externalEmailModal" tabindex="-1" aria-labelledby="externalEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="externalEmailModalLabel">External Reporting Email Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="externalEmailForm">
                    <div class="mb-3">
                        <label for="externalSubject" class="form-label">Email Subject</label>
                        <input type="text" class="form-control" id="externalSubject" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Recipients</label>
                        <div class="email-recipient-list mb-2" id="externalRecipientList">
                            <!-- Recipients will be added here dynamically -->
                        </div>
                        
                        <div class="input-group">
                            <input type="email" class="form-control" id="externalNewRecipient" placeholder="Add new recipient email">
                            <button class="btn btn-outline-secondary" type="button" id="externalAddRecipient">Add</button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="externalBodyTemplate" class="form-label">Email Template</label>
                        <textarea class="form-control" id="externalBodyTemplate" rows="6"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveExternalEmail">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Rest of your dashboard content continues here -->
<!-- Favorite Links & Files Row -->
{% if favorite_links or favorite_files %}
<!-- Rest of the existing code... -->
{% endif %}

<!-- Continue with the rest of the dashboard content... -->
{% endblock %}

{% block extra_js %}
<script>
    // Email distribution management
    document.addEventListener('DOMContentLoaded', function() {
        // Internal email data
        let internalEmailData = {
            subject: 'Internal Reporting Issue',
            recipients: ['internal-team@stryker.com'],
            bodyTemplate: 'Hello Team,\n\nI would like to report an internal issue regarding reporting.\n\nIssue Details:\n- \n- \n- \n\nThank you,'
        };
        
        // External email data
        let externalEmailData = {
            subject: 'External Reporting Issue',
            recipients: ['sales-leaders@stryker.com', 'reporting@stryker.com'],
            bodyTemplate: 'Hello Sales Leaders,\n\nI would like to report an external issue regarding reporting.\n\nIssue Details:\n- \n- \n- \n\nThank you,'
        };
        
        // Load data from server
        function loadEmailDistribution(type) {
            fetch(`/email_distribution/${type}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (type === 'internal_reporting') {
                        internalEmailData = {
                            subject: data.subject,
                            recipients: data.recipients,
                            bodyTemplate: data.body_template
                        };
                        updateInternalEmailForm();
                        updateInternalEmailButton();
                    } else if (type === 'external_reporting') {
                        externalEmailData = {
                            subject: data.subject,
                            recipients: data.recipients,
                            bodyTemplate: data.body_template
                        };
                        updateExternalEmailForm();
                        updateExternalEmailButton();
                    }
                })
                .catch(error => {
                    console.error('Error loading email distribution:', error);
                });
        }
        
        // Save data to server
        function saveEmailDistribution(type, data) {
            fetch(`/email_distribution/${type}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Show a success message
                    alert('Email distribution settings saved successfully!');
                    
                    // Update the buttons
                    if (type === 'internal_reporting') {
                        updateInternalEmailButton();
                    } else if (type === 'external_reporting') {
                        updateExternalEmailButton();
                    }
                    
                    // Close the modal
                    const modalId = type === 'internal_reporting' ? 'internalEmailModal' : 'externalEmailModal';
                    const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
                    modal.hide();
                }
            })
            .catch(error => {
                console.error('Error saving email distribution:', error);
                alert('Error saving settings. Please try again.');
            });
        }
        
        // Update the internal email form with current data
        function updateInternalEmailForm() {
            document.getElementById('internalSubject').value = internalEmailData.subject;
            document.getElementById('internalBodyTemplate').value = internalEmailData.bodyTemplate;
            
            // Update recipient list
            const recipientList = document.getElementById('internalRecipientList');
            recipientList.innerHTML = '';
            
            internalEmailData.recipients.forEach(email => {
                const recipientItem = document.createElement('div');
                recipientItem.className = 'recipient-item';
                recipientItem.innerHTML = `
                    <span>${email}</span>
                    <button type="button" class="remove-btn" data-email="${email}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                recipientList.appendChild(recipientItem);
            });
            
            // Add event listeners for remove buttons
            recipientList.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const email = this.getAttribute('data-email');
                    internalEmailData.recipients = internalEmailData.recipients.filter(e => e !== email);
                    updateInternalEmailForm();
                });
            });
        }
        
        // Update the external email form with current data
        function updateExternalEmailForm() {
            document.getElementById('externalSubject').value = externalEmailData.subject;
            document.getElementById('externalBodyTemplate').value = externalEmailData.bodyTemplate;
            
            // Update recipient list
            const recipientList = document.getElementById('externalRecipientList');
            recipientList.innerHTML = '';
            
            externalEmailData.recipients.forEach(email => {
                const recipientItem = document.createElement('div');
                recipientItem.className = 'recipient-item';
                recipientItem.innerHTML = `
                    <span>${email}</span>
                    <button type="button" class="remove-btn" data-email="${email}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                recipientList.appendChild(recipientItem);
            });
            
            // Add event listeners for remove buttons
            recipientList.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const email = this.getAttribute('data-email');
                    externalEmailData.recipients = externalEmailData.recipients.filter(e => e !== email);
                    updateExternalEmailForm();
                });
            });
        }
        
        // Update internal email button href
        function updateInternalEmailButton() {
            const mailtoUrl = `mailto:${internalEmailData.recipients.join(',')}?subject=${encodeURIComponent(internalEmailData.subject)}&body=${encodeURIComponent(internalEmailData.bodyTemplate)}`;
            document.getElementById('internalReportingBtn').href = mailtoUrl;
        }
        
        // Update external email button href
        function updateExternalEmailButton() {
            const mailtoUrl = `mailto:${externalEmailData.recipients.join(',')}?subject=${encodeURIComponent(externalEmailData.subject)}&body=${encodeURIComponent(externalEmailData.bodyTemplate)}`;
            document.getElementById('externalReportingBtn').href = mailtoUrl;
        }
        
        // Add internal recipient
        document.getElementById('internalAddRecipient').addEventListener('click', function() {
            const emailInput = document.getElementById('internalNewRecipient');
            const email = emailInput.value.trim();
            
            if (email && isValidEmail(email) && !internalEmailData.recipients.includes(email)) {
                internalEmailData.recipients.push(email);
                updateInternalEmailForm();
                emailInput.value = '';
            } else {
                alert('Please enter a valid email address that is not already in the list.');
            }
        });
        
        // Add external recipient
        document.getElementById('externalAddRecipient').addEventListener('click', function() {
            const emailInput = document.getElementById('externalNewRecipient');
            const email = emailInput.value.trim();
            
            if (email && isValidEmail(email) && !externalEmailData.recipients.includes(email)) {
                externalEmailData.recipients.push(email);
                updateExternalEmailForm();
                emailInput.value = '';
            } else {
                alert('Please enter a valid email address that is not already in the list.');
            }
        });
        
        // Save internal email settings
        document.getElementById('saveInternalEmail').addEventListener('click', function() {
            internalEmailData.subject = document.getElementById('internalSubject').value;
            internalEmailData.bodyTemplate = document.getElementById('internalBodyTemplate').value;
            
            saveEmailDistribution('internal_reporting', {
                subject: internalEmailData.subject,
                recipients: internalEmailData.recipients,
                body_template: internalEmailData.bodyTemplate
            });
        });
        
        // Save external email settings
        document.getElementById('saveExternalEmail').addEventListener('click', function() {
            externalEmailData.subject = document.getElementById('externalSubject').value;
            externalEmailData.bodyTemplate = document.getElementById('externalBodyTemplate').value;
            
            saveEmailDistribution('external_reporting', {
                subject: externalEmailData.subject,
                recipients: externalEmailData.recipients,
                body_template: externalEmailData.bodyTemplate
            });
        });
        
        // Validate email function
        function isValidEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }
        
        // Enter key for adding recipients
        document.getElementById('internalNewRecipient').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('internalAddRecipient').click();
            }
        });
        
        document.getElementById('externalNewRecipient').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('externalAddRecipient').click();
            }
        });
        
        // Initialize forms and buttons
        updateInternalEmailForm();
        updateExternalEmailForm();
        updateInternalEmailButton();
        updateExternalEmailButton();
        
        // Load data from server
        loadEmailDistribution('internal_reporting');
        loadEmailDistribution('external_reporting');
    });

    // Toggle task form functionality (keeping your existing code)
    (function() {
        const toggleBtn = document.getElementById('toggleAddTask');
        const formContainer = document.getElementById('addTaskFormContainer');
        
        if (toggleBtn && formContainer) {
            // Direct click handler
            toggleBtn.onclick = function(e) {
                e.preventDefault();
                console.log("Toggle Add Task clicked");
                
                // Toggle custom show-form class instead of Bootstrap's d-none
                formContainer.classList.toggle('show-form');
                
                // Focus the input if form is now visible
                if (formContainer.classList.contains('show-form')) {
                    const inputField = document.getElementById('newTaskInput');
                    if (inputField) {
                        setTimeout(() => {
                            inputField.focus();
                        }, 100); // Small delay to ensure DOM has updated
                    }
                }
                
                return false; // Prevent default action
            };
            
            console.log("Toggle button handler set up");
        } else {
            console.error("Could not find toggle button or form container");
        }
    })();
</script>
{% endblock %}